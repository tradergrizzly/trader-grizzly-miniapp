<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trader Grizzly Mini App</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  background: #0e0e0e;
  color: #ffffff;
}

.screen {
  display: none;
  height: 100vh;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  text-align: center;
}

.screen.active {
  display: flex;
}

h2 {
  margin-bottom: 20px;
}

select {
  width: 240px;
  padding: 12px;
  margin-bottom: 12px;
  border-radius: 10px;
  border: none;
  font-size: 15px;
}

button {
  width: 240px;
  padding: 14px;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
}

.blue { background: #3498db; color: #fff; }
.green { background: #1db954; color: #fff; }
.red { background: #e74c3c; color: #fff; }
</style>
</head>

<body>

<!-- ЭКРАН НАСТРОЕК -->
<div id="settings" class="screen active">
  <h2>Параметры анализа</h2>

  <select id="pair">
    <option>EUR/USD</option>
    <option>GBP/USD</option>
    <option>AED/CNY</option>
  </select>

  <select id="timeframe">
    <option value="60">1 минута</option>
    <option value="300">5 минут</option>
  </select>

  <select id="mode">
    <option value="STANDARD">STANDARD</option>
    <option value="OTC">OTC</option>
  </select>

  <button class="blue" onclick="getSignal()">Получить сигнал</button>
</div>

<!-- ЭКРАН ОЖИДАНИЯ -->
<div id="wait" class="screen">
  <h2>Получение сигнала…</h2>
  <p>Анализирую рынок</p>
</div>

<!-- ЭКРАН РЕЗУЛЬТАТА -->
<div id="result" class="screen">
  <h1 id="resultText"></h1>
  <button class="blue" onclick="reset()">Следующий сигнал</button>
</div>

<script>
const API = "https://scleroid-measureless-kaya.ngrok-free.dev";

let tradeId = null;

function show(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
}

function getSignal() {
  show("wait");

  fetch(API + "/signal", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      pair: document.getElementById("pair").value,
      timeframe: parseInt(document.getElementById("timeframe").value),
      mode: document.getElementById("mode").value
    })
  })
  .then(res => res.json())
  .then(data => {
    tradeId = data.trade_id;
    pollResult();
  })
  .catch(() => {
    alert("Ошибка связи с сервером");
    reset();
  });
}

function pollResult() {
  const timer = setInterval(() => {
    fetch(API + "/status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ trade_id: tradeId })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "DONE") {
        clearInterval(timer);
        showResult(data.result);
      }
    });
  }, 3000);
}

function showResult(result) {
  show("result");
  const el = document.getElementById("resultText");

  if (result === "PLUS") {
    el.innerText = "ПЛЮС\nПоздравляем с победой!";
    document.getElementById("result").style.background = "#1db954";
  } else {
    el.innerText = "МИНУС\nСделка не зашла";
    document.getElementById("result").style.background = "#e74c3c";
  }
}

function reset() {
  document.getElementById("result").style.background = "#0e0e0e";
  show("settings");
}
</script>

</body>
</html>
